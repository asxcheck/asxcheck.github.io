<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ASX Live Quotes — Real-time Stocks with Interactive Chart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Lightweight, modern UI font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <style>
    :root {
  --bg: #0b0f1a;
  --card: #12182a;
  --card-2: #1a2033;
  --muted: #8b96a9;
  --text: #e6eaf3;
  --accent: #2ea7ff;
  --grid: rgba(255,255,255,.08);
  --green: #27c782;
  --red: #ff5c5c;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto;
      color: var(--text);
      background: radial-gradient(circle at 20% -10%, rgba(79,154,255,.15) 0%, rgba(79,154,255,.0) 40%),
                  radial-gradient(circle at 100% 0%, rgba(255,255,255,.06) 0%, rgba(255,255,255,.0) 40%),
                  linear-gradient(#0b0e1a, #0b0e1a);
    }

    header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid var(--grid);
      position: sticky;
      top: 0;
      background: rgba(15,18,32,.92);
      backdrop-filter: saturate(1.2) blur(6px);
      z-index: 10;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand .logo {
      width: 38px; height: 38px;
      border-radius: 9px;
      background: linear-gradient(135deg, #4f9aff 0%, #7c5cff 70%);
      display: inline-block;
    }

    h1 {
      font-size: 1.15rem;
      font-weight: 700;
      margin: 0;
      letter-spacing: .2px;
    }

    main.layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 14px;
      padding: 14px 16px 40px;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    /* Panels */
    .panel {
      background: linear-gradient(180deg, rgba(20,25,50,.95), rgba(20,25,50,.92));
      border: 1px solid var(--grid);
      border-radius: 12px;
      padding: 12px;
      min-height: 400px;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
    }

    #watchPanel .panelHeader {
      display: flex; align-items: center; justify-content: space-between;
      padding: 6px 6px 6px 6px;
      margin-bottom: 6px;
      border-bottom: 1px solid var(--grid);
    }
    #watchPanel h2 { font-size: 0.95rem; margin: 0; font-weight: 700; }
    #watchPanel input[type="search"] {
      width: 100%;
      max-width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--grid);
      background: #0a1130;
      color: var(--text);
    }

    #stockList { display: grid; gap: 6px; max-height: calc(100% - 50px); overflow: auto; padding-right: 6px; }

    .stockItem {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 8px;
      padding: 8px;
      border-radius: 8px;
      background: linear-gradient(180deg, rgba(7,12,28,.6), rgba(7,12,28,.3));
      border: 1px solid var(--grid);
    }
    .stockItem:hover { border-color: var(--accent); background: linear-gradient(180deg, rgba(10,16,34,.7), rgba(10,16,34,.45)); cursor: pointer; }
  .stockItem.primary { border-color: var(--accent); box-shadow: inset 0 0 0 1px var(--accent); }
    .stockItem .left {
      display: grid; grid-template-columns: auto 1fr;
      gap: 8px; align-items: center;
    }
    .stockItem .checkbox {
      display: inline-flex; align-items: center; gap: 8px;
    }
    .stockItem .checkbox input[type="checkbox"] {
      appearance: none; -webkit-appearance: none; -moz-appearance: none;
      width: 18px; height: 18px; border: 2px solid var(--grid);
      border-radius: 4px; display: inline-block; position: relative;
      background: transparent; transition: all .15s ease;
    }
    .stockItem .checkbox input[type="checkbox"]:hover { border-color: var(--accent); }
    .stockItem .checkbox input[type="checkbox"]:checked { background: var(--accent); border-color: var(--accent); }
    .stockItem .checkbox input[type="checkbox"]:checked::after {
      content: ''; position: absolute; left: 4px; top: 1px; width: 5px; height: 9px;
      border: 2px solid #fff; border-top: 0; border-left: 0; transform: rotate(45deg);
    }
  .chkLabel { display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none; }
    .stockName { font-weight: 600; font-size: 0.9rem; }
    .stockSymbol { color: var(--muted); font-size: .85rem; }
    .stockRowRight {
      text-align: right;
      min-width: 120px;
    }
    .price { font-weight: 700; font-feature-settings: 'tnum' 1; }
    .deltaBadge { display:inline-block; margin-left:8px; padding:2px 6px; border-radius:6px; font-size:.72rem; font-weight:700; }

    .statCard {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;
      margin-top: 8px;
    }

    .statTile {
      background: rgba(255,255,255,.04);
      border: 1px solid var(--grid);
      border-radius: 10px;
      padding: 8px 10px;
      display: grid; gap: 4px;
    }
    .statTile .label { font-size: .75rem; color: var(--muted); }
    .statTile .value { font-size: 1.05rem; font-weight: 700; }

    #chartCard {
      min-height: 400px;
      display: grid; grid-template-rows: auto 1fr;
      overflow: hidden;
    }
      #chartCard canvas {
      width: 100% !important;
       height: 420px !important;
        }

    @media (max-width: 980px) {
      main.layout {
        grid-template-columns: 1fr;
        padding: 8px 12px 40px;
      }
      #watchPanel { order: 2; }
      #chartCard { order: 1; height: 420px; }
    }

    /* Auth overlay */
    #authOverlay {
      position: fixed;
      inset: 0;
      background: rgba(10, 12, 24, 0.9);
      backdrop-filter: blur(6px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    #authCard {
      background: var(--card);
      border: 1px solid var(--grid);
      border-radius: 12px;
      padding: 18px;
      width: 320px;
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
    }
    #authCard h3 { margin: 0 0 10px 0; }
    #authCard input[type="password"] {
      width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--grid);
      background: #0a1130; color: var(--text); margin: 8px 0 12px 0;
    }
    #authCard button {
      width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--grid);
      background: #0a0f2a; color: var(--text); cursor: pointer; font-weight: 700;
    }
  </style>
</head>
<body>
  <header>
    <div class="brand" aria-label="Brand">
      <span class="logo" aria-hidden="true"></span>
      <div>
        <h1>ASX Live Quotes</h1>
        <div style="font-size:.8rem; color:var(--muted)">
          Real-time prices for selected ASX stocks with an AI-ready data structure.
        </div>
      </div>
    </div>
    <div aria-label="AI-ready export" style="text-align:right">
      <button id="exportAiBtn" style="padding:8px 12px; border-radius:6px; border:1px solid var(--grid); background:#0a0f2a; color:var(--text); cursor:pointer">
        Export AI-ready data
      </button>
      <button id="dataSourceBtn" style="padding:8px 12px; border-radius:6px; border:1px solid var(--grid); background:#0a0f2a; color:var(--text); cursor:pointer; margin-left:8px">
        Data source
      </button>
    </div>
  </header>

  <main class="layout" aria-label="Main layout with stock selector and chart">
    <!-- Watchlist / Stock selector -->
    <aside id="watchPanel" class="panel" aria-label="Stock selection panel">
      <div class="panelHeader">
        <h2>Stocks to display</h2>
        <input id="searchInput" type="search" placeholder="Search ASX stocks…" aria-label="Search stocks" />
      </div>
      <div id="stockList" aria-label="List of available stocks">
        <!-- Dynamically generated rows -->
      </div>
      <div class="statCard" id="summaryPanel" aria-label="Basic summary stats for selected stocks">
        <!-- Summary tiles for quick glance (daily change, volume, etc.) -->
      </div>
    </aside>

    <!-- Interactive chart -->
    <section id="chartCard" class="panel" aria-label="Interactive price chart for selected stocks">
      <div style="padding:6px 6px 0 6px; display:flex; justify-content: space-between; align-items: center; gap:8px; flex-wrap:wrap">
        <div style="font-weight:700; font-size:1rem;">Price Movement</div>
        <div style="display:flex; align-items:center; gap:8px; margin-left:auto">
          <div style="font-size:.85rem; color:var(--muted)">Updates every second</div>
          <div id="compareControls" style="display:flex; align-items:center; gap:6px;">
            <input id="compareInput" list="symbolsList" placeholder="Compare (e.g., CBA.AX)" aria-label="Add comparison symbol" style="padding:6px 8px; border-radius:8px; border:1px solid var(--grid); background:#0a1130; color:var(--text); width:180px;" />
            <button id="compareAddBtn" title="Add" style="padding:6px 8px; border-radius:6px; border:1px solid var(--grid); background:#0a0f2a; color:var(--text); cursor:pointer">Add</button>
            <div id="compareTags" style="display:flex; gap:6px; flex-wrap:wrap"></div>
          </div>
        </div>
      </div>
      <datalist id="symbolsList"></datalist>
      <canvas id="priceChart" height="420" aria-label="Price chart canvas"></canvas>
    </section>
  </main>
  <!-- Simple password gate (client-side only) -->
  <div id="authOverlay" aria-modal="true" role="dialog">
    <div id="authCard">
      <h3>Enter Password</h3>
      <div style="font-size:.85rem; color:var(--muted)">This site is restricted. Please enter the access password.</div>
      <input id="authPassword" type="password" placeholder="Password" aria-label="Password" />
      <div id="authError" style="color: var(--red); display:none; font-size:.85rem; margin-bottom:8px">Incorrect password. Try again.</div>
      <button id="authSubmit">Unlock</button>
    </div>
  </div>

  <footer style="text-align:center; padding:20px; color:var(--muted);">
    Disclaimer: Real-time data requires a live data feed. In environments without a connected feed, a mock provider is used for demonstration.
  </footer>

  <script>
    // == CONFIG / DATA ==
    // CORS/Provider configuration. For static deployments (e.g., GitHub Pages),
    // direct calls to Yahoo will be blocked by CORS. Set YAHOO_PROXY to a
    // small server/worker you control that forwards to Yahoo and adds
    // Access-Control-Allow-Origin: *. Leave empty to skip Yahoo on GH Pages.
    const CONFIG = {
      // Set to a proxy base that mirrors Yahoo paths, e.g.
      //   https://your-worker.example.workers.dev
      // The app will call: `${YAHOO_PROXY}/v7/finance/quote?...` and `/v8/finance/chart/...`
      YAHOO_PROXY: 'https://asx.mrlaurules.workers.dev',
    };

    const CATALOG = [
      { symbol: 'BHP.AX', name: 'BHP Group Ltd', color: '#4f8cff' },
      { symbol: 'CSL.AX', name: 'CSL Limited', color: '#00d084' },
      { symbol: 'CBA.AX', name: 'Commonwealth Bank of Australia', color: '#f72585' },
      { symbol: 'WBC.AX', name: 'Westpac Banking Corp', color: '#ffd166' },
      { symbol: 'NAB.AX', name: 'National Australia Bank', color: '#118ab2' },
      { symbol: 'TLS.AX', name: 'Telstra Corp', color: '#84cc16' },
      { symbol: 'ANZ.AX', name: 'Australia and New Zealand Banking Group', color: '#f57c00' },
    ];
    const state = {
      selected: new Set(['BHP.AX','CSL.AX','CBA.AX']),
  primarySymbol: 'BHP.AX',
  compareSymbols: new Set(),
      prices: {},
      volumes: {},
      history: {},
      openingPrice: {},
      chart: null,
      chartDatasets: {},
      lastUpdate: 0,
      colorsBySymbol: {},
  isMock: false // toggled when demo feed is used
    };
    const COLOR_POOL = [
      '#4f8cff', '#4caf50', '#ff7b54', '#f44336', '#ffd166',
      '#8e44ad', '#2ecc71', '#1abc9c', '#e67e22', '#e74c3c', '#9b59b6'
    ];

    // == UI HELPERS ==
    const stockListEl = document.getElementById('stockList');
    const searchInput = document.getElementById('searchInput');
    const priceChartCtx = document.getElementById('priceChart').getContext('2d');
    const summaryPanel = document.getElementById('summaryPanel');
  const exportAiBtn = document.getElementById('exportAiBtn');
  const dataSourceBtn = document.getElementById('dataSourceBtn');
  const compareInput = document.getElementById('compareInput');
  const compareAddBtn = document.getElementById('compareAddBtn');
  const compareTags = document.getElementById('compareTags');
  const symbolsList = document.getElementById('symbolsList');

    function fmt(n) {
      if (n === undefined || n === null || Number.isNaN(n)) return '-';
      return Number(n).toFixed(2);
    }
    function deltaColor(delta) {
      if (delta > 0) return 'var(--green)';
      if (delta < 0) return 'var(--red)';
      return 'var(--muted)';
    }
    function colorForSymbol(symbol) {
      if (state.colorsBySymbol[symbol]) return state.colorsBySymbol[symbol];
      const used = Object.values(state.colorsBySymbol);
      const idx = used.length % COLOR_POOL.length;
      const color = COLOR_POOL[idx];
      state.colorsBySymbol[symbol] = color;
      return color;
    }

    // == CHART (Chart.js) ==
    function initChart() {
      // Destroy previous chart if it exists
      if (state.chart) {
        state.chart.destroy();
        state.chart = null;
      }
      const datasets = [];
    state.selected.forEach((sym) => {
        const color = colorForSymbol(sym);
        datasets.push({
          label: sym,
          data: [],
          borderColor: color,
          backgroundColor: color + '44',
          fill: false,
      tension: 0,
          pointRadius: 0,
          borderWidth: 2,
          parsing: false
        });
      });
      state.chartDatasets = {};
      datasets.forEach(ds => {
        state.chartDatasets[ds.label] = ds;
      });
      state.chart = new Chart(priceChartCtx, {
        type: 'line',
        data: { datasets: datasets, labels: [] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          interaction: { mode: 'nearest', intersect: false },
          plugins: {
            legend: { display: true, position: 'top', labels: { color: 'var(--muted)', usePointStyle: true, boxHeight: 6, boxWidth: 10 } },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: (ctx) => {
                  const s = ctx.dataset.label;
                  const price = ctx.raw?.y ?? ctx.parsed?.y ?? '';
                  return `${s}: ${fmt(price)}`;
                }
              }
            }
          },
          scales: {
            x: {
              type: 'time',
              time: { displayFormats: { millisecond: 'HH:mm:ss', second: 'HH:mm:ss', minute: 'HH:mm', }},
              grid: { color: 'var(--grid)' },
              ticks: { color: 'var(--muted)' },
            },
            y: {
              beginAtZero: false,
              position: 'right',
              grid: { color: 'var(--grid)' },
              title: { display: true, text: 'Price (AUD)' },
              ticks: { color: 'var(--muted)' }
            }
          }
        }
      });
    }

    function pushPricePoint(symbol, price, ts, volume) {
      if (!state.history[symbol]) state.history[symbol] = [];
      state.history[symbol].push({ t: ts, price, volume });
      if (state.openingPrice[symbol] === undefined) { state.openingPrice[symbol] = price; }
      state.prices[symbol] = price;
      state.volumes[symbol] = volume;

      let ds = state.chartDatasets[symbol];
      if (!ds) {
        const color = colorForSymbol(symbol);
        ds = {
          label: symbol,
          data: [],
          borderColor: color,
          backgroundColor: color + '44',
          fill: false,
          tension: 0.25,
          pointRadius: 0,
          borderWidth: 2,
          parsing: false
        };
        state.chart.data.datasets.push(ds);
        state.chartDatasets[symbol] = ds;
        state.chart.update('none');
      }
      ds.data.push({ x: ts, y: price });
      const MAX_POINTS = 600;
      if (ds.data.length > MAX_POINTS) ds.data.shift();

      const maxLen = Math.max(...Object.values(state.chartDatasets).map(d => d.data.length));
      for (const other of Object.values(state.chartDatasets)) {
        while (other.data.length < maxLen) {
          const last = other.data.length > 0 ? other.data[other.data.length - 1].y : price;
          other.data.push({ x: ts, y: last });
        }
      }
      state.chart.update('none');
    }

    function updateSelectedFromPrimaryAndCompare() {
      const newSelected = new Set([state.primarySymbol, ...state.compareSymbols]);
      // Remove datasets not in newSelected
      for (const sym of Array.from(state.selected)) {
        if (!newSelected.has(sym)) {
          const ds = state.chartDatasets[sym];
          if (ds) {
            const idx = state.chart.data.datasets.indexOf(ds);
            if (idx !== -1) state.chart.data.datasets.splice(idx, 1);
            delete state.chartDatasets[sym];
          }
        }
      }
      // Add datasets for new symbols
      for (const sym of Array.from(newSelected)) {
        ensureSymbolDataset(sym);
      }
      state.selected = newSelected;
      state.chart.update('none');
      renderSummaryTiles();
      renderCatalogList(searchInput.value);
    }

    function setPrimary(sym) {
      if (!sym) return;
      state.primarySymbol = sym;
      updateSelectedFromPrimaryAndCompare();
    }

    function addCompare(sym) {
      if (!sym || sym === state.primarySymbol) return;
      state.compareSymbols.add(sym);
      updateSelectedFromPrimaryAndCompare();
    }

    function removeCompare(sym) {
      state.compareSymbols.delete(sym);
      updateSelectedFromPrimaryAndCompare();
    }

    function renderSummaryTiles() {
      summaryPanel.innerHTML = '';
      state.selected.forEach(sym => {
        const price = state.prices[sym];
        const open = state.openingPrice[sym] ?? price;
        const delta = price != null && open != null ? price - open : 0;
        const deltaPct = (open !== 0 && price != null) ? (delta / open) * 100 : 0;
        const tile = document.createElement('div');
        tile.className = 'statTile';
        tile.style.borderLeft = `4px solid ${state.colorsBySymbol[sym] || '#fff'}`;
        tile.innerHTML = `
          <div class="label" style="font-size:.75rem; color:var(--muted)">${sym}</div>
          <div class="value" aria-label="Current price">${fmt(price)}</div>
          <div style="font-size:.75rem; color:${delta >= 0 ? 'var(--green)' : 'var(--red)'}">
            ${delta >= 0 ? '▲' : delta < 0 ? '▼' : '•'} ${fmt(delta)} (${fmt(deltaPct)}%)
          </div>
          <div style="font-size:.7rem; color:var(--muted)">${state.volumes[sym] ?? 0} vol</div>
        `;
        summaryPanel.appendChild(tile);
      });
    }

    // == REAL-TIME FEED (REAL OR MOCK) ==
  class RealTimeProvider {
      constructor(url, apiKey) {
        this.url = url; this.apiKey = apiKey; this.ws = null;
        this.callbacks = []; this.subscribed = new Set();
        this.shouldReconnect = true; this.reconnectDelay = 1000;
      }
      connect() { /* ... truncated for brevity ... */ }
      get selectedSymbols() { return Array.from(state.selected); }
      subscribe(symbols) { /* ... truncated for brevity ... */ }
      onMessage(cb) { this.callbacks.push(cb); }
      reconnect() { if (!this.shouldReconnect) return; setTimeout(() => this.connect(), this.reconnectDelay); }
      close() { this.shouldReconnect = false; if (this.ws) this.ws.close(); }
    }


    // == DATA FETCH (Yahoo Finance)
    async function fetchYahooFinanceQuotes(symbols) {
      if (!symbols || symbols.length === 0) return {};
      const joined = symbols.map(encodeURIComponent).join(',');
      const onGithubPages = /\.github\.io$/i.test(location.hostname);
      // Prefer proxy when configured (recommended for GH Pages/static hosting)
      if (CONFIG.YAHOO_PROXY) {
        try {
          const proxiedUrl = `${CONFIG.YAHOO_PROXY}/v7/finance/quote?symbols=${joined}`;
          const resp = await fetch(proxiedUrl, { cache: 'no-cache' });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();
          // Expecting the worker to return Yahoo's JSON shape
          const results = data.quoteResponse?.result || [];
          const out = {};
          for (const r of results) {
            if (r && r.symbol && r.regularMarketPrice != null) {
              out[r.symbol] = {
                price: r.regularMarketPrice,
                volume: r.regularMarketVolume || 0,
                ts: Date.now()
              };
            }
          }
          return out;
        } catch (e) {
          console.warn('Yahoo (proxied) fetch error:', e);
          return {};
        }
      }

      // If no proxy and running on GitHub Pages, skip direct Yahoo to avoid noisy CORS errors
      if (onGithubPages) {
        console.info('Skipping direct Yahoo fetch on GitHub Pages (CORS). Configure CONFIG.YAHOO_PROXY to enable.');
        return {};
      }

      const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${joined}`;
      try {
        const resp = await fetch(url, { cache: 'no-cache' });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        const results = data.quoteResponse?.result || [];
        const out = {};
        for (const r of results) {
          if (r && r.symbol && r.regularMarketPrice != null) {
            out[r.symbol] = {
              price: r.regularMarketPrice,
              volume: r.regularMarketVolume || 0,
              ts: Date.now()
            };
          }
        }
        return out;
      } catch (e) {
        console.warn('Yahoo (direct) fetch error:', e);
        return {};
      }
    }

    // Fetch intraday history for seeding the chart (range: 1d, interval: 1m)
    async function fetchYahooChartHistory(symbol, range = '1d', interval = '1m') {
      const onGithubPages = /\.github\.io$/i.test(location.hostname);
      let url = '';
      if (CONFIG.YAHOO_PROXY) {
        url = `${CONFIG.YAHOO_PROXY}/v8/finance/chart/${encodeURIComponent(symbol)}?range=${encodeURIComponent(range)}&interval=${encodeURIComponent(interval)}`;
      } else if (!onGithubPages) {
        url = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?range=${encodeURIComponent(range)}&interval=${encodeURIComponent(interval)}`;
      } else {
        return null;
      }
      try {
        const resp = await fetch(url, { cache: 'no-cache' });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        const res = data?.chart?.result?.[0];
        if (!res) return null;
        const ts = res.timestamp || [];
        const quote = res.indicators?.quote?.[0] || {};
        const closes = quote.close || [];
        const volumes = quote.volume || [];
        const points = [];
        for (let i = 0; i < ts.length; i++) {
          const p = closes[i];
          if (p == null || Number.isNaN(p)) continue;
          points.push({ t: ts[i] * 1000, price: p, volume: volumes?.[i] ?? 0 });
        }
        return points;
      } catch (e) {
        console.warn('Yahoo chart history fetch error:', e);
        return null;
      }
    }

  function startYahooFinanceFeed() {
      // Store last fetched prices
      let lastPrices = {};
      let lastVolumes = {};
      let lastTimestamps = {};
      let noDataCount = 0;
      const onGithubPages = /\.github\.io$/i.test(location.hostname);
  // If we are on GH Pages and no proxy configured, go straight to demo mode
      if (onGithubPages && !CONFIG.YAHOO_PROXY) {
        showNoDataMessage();
        startDemoFeed();
        return;
      }
      // Poll Yahoo Finance every 5 seconds (faster, but don't abuse)
      async function poll() {
        const syms = Array.from(state.selected);
        const batch = await fetchYahooFinanceQuotes(syms);
        let gotAny = Object.keys(batch).length > 0;
        for (const sym of syms) {
          const result = batch[sym];
          if (result && !isNaN(result.price)) {
            lastPrices[sym] = result.price;
            lastVolumes[sym] = result.volume;
            lastTimestamps[sym] = result.ts;
            pushPricePoint(sym, result.price, result.ts, result.volume);
          }
        }
        if (!gotAny) {
          noDataCount++;
          if (noDataCount >= 2) {
            showNoDataMessage();
            // If a proxy is configured, keep retrying without falling back to demo
            if (!CONFIG.YAHOO_PROXY) {
              startDemoFeed();
              return;
            }
          }
        } else {
          noDataCount = 0;
          hideNoDataMessage();
        }
        setTimeout(poll, 5000); // 5 seconds
      }
      poll();

  // Update UI every second with the latest known prices
      setInterval(() => {
        const syms = Array.from(state.selected);
        const now = Date.now();
        syms.forEach(sym => {
          if (lastPrices[sym] !== undefined) {
            // Push the last known price with a new timestamp for smooth chart update
            pushPricePoint(sym, lastPrices[sym], now, lastVolumes[sym]);
          }
        });
        updateLivePricesUI();
        renderSummaryTiles();
      }, 1000);
    }

    // Restore MockRealTimeProvider for fallback demo mode
    class MockRealTimeProvider {
      constructor(symbols, onTick) { this.symbols = symbols; this.onTick = onTick; this.interval = null; }
      start() {
        this.symbols.forEach(sym => {
          if (state.prices[sym] == null) {
            state.prices[sym] = 50 + Math.random() * 50;
            state.openingPrice[sym] = state.prices[sym];
          }
        });
        this.interval = setInterval(() => {
          const ts = Date.now();
          this.symbols.forEach(sym => {
            const last = state.prices[sym] ?? 50;
            const delta = (Math.random() - 0.5) * 0.6;
            const newPrice = Math.max(0.01, last + delta);
            const volume = Math.floor(100 + Math.random() * 1000);
            if (typeof this.onTick === 'function') {
              this.onTick({ symbol: sym, price: newPrice, ts, volume });
            }
          });
        }, 900);
      }
      stop() { if (this.interval) clearInterval(this.interval); }
    }

    // Show/hide a message if no data is available
  function showNoDataMessage() {
      let msg = document.getElementById('noDataMsg');
      if (!msg) {
        msg = document.createElement('div');
        msg.id = 'noDataMsg';
        msg.style.position = 'fixed';
        msg.style.top = '60px';
        msg.style.left = '50%';
        msg.style.transform = 'translateX(-50%)';
        msg.style.background = '#ff5c5c';
        msg.style.color = '#fff';
        msg.style.padding = '12px 24px';
        msg.style.borderRadius = '8px';
        msg.style.zIndex = '1000';
        msg.style.fontWeight = 'bold';
            msg.innerText = CONFIG.YAHOO_PROXY
              ? 'Data temporarily unavailable. Retrying with proxy…'
              : 'Live data unavailable (CORS). Add a Yahoo proxy in Data source settings to enable live prices.';
        document.body.appendChild(msg);
      }
    }
    function hideNoDataMessage() {
      const msg = document.getElementById('noDataMsg');
      if (msg) msg.remove();
    }

    // Fallback: Demo feed (mock data)
    function startDemoFeed() {
      bootstrapChart();
      const mock = new MockRealTimeProvider(Array.from(state.selected), (msg) => {
        pushPricePoint(msg.symbol, msg.price, msg.ts, msg.volume);
        updateLivePricesUI();
      });
      mock.start();
      renderSummaryTiles();
    }

    // == UI BINDING ==
    function renderCatalogList(filter = '') {
      stockListEl.innerHTML = '';
      const q = filter.trim().toLowerCase();
      CATALOG.forEach(item => {
        const match = !q || item.name.toLowerCase().includes(q) || item.symbol.toLowerCase().includes(q);
        if (!match) return;
        const symbol = item.symbol;
        const isSelected = state.selected.has(symbol);
        const row = document.createElement('div');
        row.className = 'stockItem' + (symbol === state.primarySymbol ? ' primary' : '');
        const price = state.prices[symbol];
        const open = state.openingPrice[symbol] ?? price;
        const delta = price != null && open != null ? price - open : 0;
        const deltaPct = open ? (delta / open * 100) : 0;
        row.innerHTML = `
          <div class="left">
            <label class="chkLabel" for="chk-${symbol}" aria-label="Toggle ${symbol}">
              <span class="checkbox"><input type="checkbox" id="chk-${symbol}" ${isSelected ? 'checked' : ''} /></span>
              <span>
                <div class="stockName" title="${item.name}">${item.name}</div>
                <div class="stockSymbol" style="margin-top:2px">${symbol}</div>
              </span>
            </label>
          </div>
          <div class="stockRowRight" aria-label="Current price for ${symbol}">
            <span id="latest-${symbol}" class="price">${price != null ? fmt(price) : '-'}</span>
            <span class="deltaBadge" style="background:${delta >= 0 ? 'rgba(39,199,130,.15)' : 'rgba(255,92,92,.15)'}; color:${delta >= 0 ? 'var(--green)' : 'var(--red)'}">${delta >= 0 ? '▲' : '▼'} ${isFinite(deltaPct) ? fmt(deltaPct) : '0.00'}%</span>
          </div>
        `;
        stockListEl.appendChild(row);
        // Row click sets primary symbol for focused view
        row.addEventListener('click', (ev) => {
          const target = ev.target;
          if (target && target.closest && target.closest('label')) return; // ignore checkbox/label
          setPrimary(symbol);
        });
        const chk = row.querySelector('input[type="checkbox"]');
        chk.addEventListener('change', async (e) => {
          if (e.target.checked) {
            addCompare(symbol);
            try { await seedHistory([symbol]); } catch {}
          } else {
            removeCompare(symbol);
          }
          renderSummaryTiles();
        });
      });
    }

    function ensureSymbolDataset(symbol) {
      if (!state.chartDatasets[symbol] && state.chart) {
        const color = colorForSymbol(symbol);
        const ds = {
          label: symbol,
          data: [],
          borderColor: color,
          backgroundColor: color + '44',
          fill: false,
          tension: 0,
          parsing: false
        };
        state.chart.data.datasets.push(ds);
        state.chartDatasets[symbol] = ds;
        state.chart.update('none');
      }
    }

    searchInput.addEventListener('input', (e) => {
      renderCatalogList(e.target.value);
    });

    function updateLivePricesUI() {
      renderCatalogList(searchInput.value);
      renderSummaryTiles();
    }

    function buildAIInput() {
      const current = {};
      const history = {};
      const opening = {};
      const stats = {};
      state.selected.forEach(sym => {
        current[sym] = state.prices[sym] ?? null;
        history[sym] = state.history[sym] ?? [];
        opening[sym] = state.openingPrice[sym] ?? null;
        const last = state.prices[sym] ?? opening[sym] ?? null;
        const open = opening[sym] ?? last ?? 0;
        const delta = (last ?? 0) - (open ?? 0);
        const pct = (open ? delta / open * 100 : 0);
        stats[sym] = { dailyChange: delta, dailyChangePct: pct };
      });
      // Volatility feature
      const volatilityWindow = 20;
      const volatility = {};
      state.selected.forEach(sym => {
        const hist = history[sym];
        const len = hist.length;
        const window = hist.slice(Math.max(0, len - volatilityWindow), len);
        const prices = window.map(p => p.price);
        if (prices.length >= 2) {
          const mean = prices.reduce((a,b)=>a+b,0)/prices.length;
          const varr = prices.reduce((acc,p)=> acc + (p-mean)*(p-mean), 0) / (prices.length-1);
          volatility[sym] = Math.sqrt(varr);
        } else {
          volatility[sym] = 0;
        }
      });
      return { current, history, opening, stats, features: { volatility } };
    }

    function downloadAIData() {
      const aiInput = buildAIInput();
      const blob = new Blob([JSON.stringify(aiInput, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ai_input_live_asx.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    exportAiBtn.addEventListener('click', () => {
      downloadAIData();
    });

    // Compare controls
    function renderCompareTags() {
      if (!compareTags) return;
      compareTags.innerHTML = '';
      Array.from(state.compareSymbols).forEach(sym => {
        const tag = document.createElement('span');
        tag.style.padding = '4px 8px';
        tag.style.border = '1px solid var(--grid)';
        tag.style.borderRadius = '999px';
        tag.style.fontSize = '.78rem';
        tag.style.background = 'rgba(255,255,255,.04)';
        tag.style.display = 'inline-flex';
        tag.style.alignItems = 'center';
        tag.style.gap = '6px';
        tag.innerHTML = `${sym} <button aria-label="Remove ${sym}" style="background:transparent; color:var(--muted); border:0; cursor:pointer">✕</button>`;
        tag.querySelector('button')?.addEventListener('click', () => removeCompare(sym));
        compareTags.appendChild(tag);
      });
    }
    function setupCompareControls() {
      if (!symbolsList) return;
      // Populate datalist
      symbolsList.innerHTML = CATALOG.map(c => `<option value="${c.symbol}">${c.name}</option>`).join('');
      const addFromInput = () => {
        const val = (compareInput.value || '').trim().toUpperCase();
        compareInput.value = '';
        if (!val) return;
        const exists = CATALOG.some(c => c.symbol.toUpperCase() === val);
        if (!exists) return;
        addCompare(val);
        seedHistory([val]).catch(()=>{});
        renderCompareTags();
      };
      compareAddBtn?.addEventListener('click', addFromInput);
      compareInput?.addEventListener('keydown', (e) => { if (e.key === 'Enter') addFromInput(); });
    }

    // == INITIALIZATION ==
  function bootstrapChart() { initChart(); }
    renderCatalogList();

    // Simple client-side password gate (note: not secure; use server auth for real protection)
    const PASSWORD = 'acer'; // change this to your desired password
    let authed = false;
    async function unlockIfValid() {
      const input = document.getElementById('authPassword');
      const err = document.getElementById('authError');
      const val = (input?.value || '').trim();
      if (!val) { err.style.display = 'block'; return; }
      if (val === PASSWORD) {
        authed = true;
        document.getElementById('authOverlay').style.display = 'none';
        // optionally remember session
        try { sessionStorage.setItem('asx_authed', '1'); } catch {}
        init();
      } else {
        err.style.display = 'block';
      }
    }

    async function seedHistory(symbols) {
      // Seed chart with intraday points for smoother initial UX
      const tasks = symbols.map(async (sym) => {
        try {
          const points = await fetchYahooChartHistory(sym, '1d', '1m');
          if (!points || points.length === 0) return;
          // Set opening price to first point if not present
          if (state.openingPrice[sym] == null && points[0]) state.openingPrice[sym] = points[0].price;
          ensureSymbolDataset(sym);
          const ds = state.chartDatasets[sym];
          // Replace dataset data in bulk for performance
          ds.data = points.map(p => ({ x: p.t, y: p.price }));
          state.prices[sym] = points[points.length - 1].price;
          state.volumes[sym] = points[points.length - 1].volume;
        } catch {}
      });
      await Promise.allSettled(tasks);
      state.chart.update('none');
      renderSummaryTiles();
    }

    function loadSavedConfig() {
      try {
        const saved = localStorage.getItem('asx_yahoo_proxy');
  if (saved && saved.trim() !== '') CONFIG.YAHOO_PROXY = saved;
      } catch {}
    }

    function initDataSourceModal() {
      const modal = document.createElement('div');
      modal.id = 'dataSourceModal';
      modal.style.position = 'fixed';
      modal.style.inset = '0';
      modal.style.display = 'none';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
      modal.style.background = 'rgba(10,12,24,0.8)';
      modal.style.zIndex = '10001';
      modal.innerHTML = `
        <div style="width:520px; max-width:90vw; background: var(--card); border:1px solid var(--grid); border-radius:12px; padding:16px;">
          <div style="font-weight:700; font-size:1rem; margin-bottom:8px;">Data source settings</div>
          <div style="font-size:.85rem; color:var(--muted); margin-bottom:8px;">
            Paste your Yahoo proxy base URL. Example: https://your-worker.example.workers.dev
            This should mirror Yahoo paths, allowing requests to /v7/finance/quote and /v8/finance/chart.
          </div>
          <input id="proxyInput" type="text" placeholder="https://your-worker.example.workers.dev" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--grid); background:#0a1130; color:var(--text);" />
          <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
            <button id="proxyCancel" style="padding:8px 12px; border-radius:6px; border:1px solid var(--grid); background:#0a0f2a; color:var(--text); cursor:pointer">Cancel</button>
            <button id="proxySave" style="padding:8px 12px; border-radius:6px; border:1px solid var(--grid); background:#143; color:#c8facc; cursor:pointer; font-weight:700">Save</button>
          </div>
          <div style="margin-top:10px; font-size:.8rem; color:var(--muted);">
            Tip: Use a Cloudflare Worker to proxy to https://query1.finance.yahoo.com and add CORS headers. After saving, the app will fetch real prices and seed history.
          </div>
        </div>`;
      document.body.appendChild(modal);

      const open = () => {
        const input = modal.querySelector('#proxyInput');
        input.value = CONFIG.YAHOO_PROXY || '';
        modal.style.display = 'flex';
        input.focus();
      };
      const close = () => { modal.style.display = 'none'; };
      dataSourceBtn?.addEventListener('click', open);
      modal.querySelector('#proxyCancel')?.addEventListener('click', close);
      modal.querySelector('#proxySave')?.addEventListener('click', () => {
        const val = modal.querySelector('#proxyInput').value.trim().replace(/\/$/, '');
        CONFIG.YAHOO_PROXY = val;
        try { localStorage.setItem('asx_yahoo_proxy', val); } catch {}
        close();
      });
    }

    async function init() {
      loadSavedConfig();
      bootstrapChart();
  // Initialize primary as first of default selection if not present
  if (!state.primarySymbol) state.primarySymbol = Array.from(state.selected)[0];
  // Compare symbols start as the rest of the default selection
  state.compareSymbols = new Set(Array.from(state.selected).filter(s => s !== state.primarySymbol));
  updateSelectedFromPrimaryAndCompare();
  setupCompareControls();
      // Seed if possible; non-blocking start of live feed
  seedHistory([state.primarySymbol, ...state.compareSymbols]).finally(() => {
        startYahooFinanceFeed();
      });
    }

    window.addEventListener('load', () => {
  initDataSourceModal();
      try { if (sessionStorage.getItem('asx_authed') === '1') { authed = true; document.getElementById('authOverlay').style.display = 'none'; init(); return; } } catch {}
      const btn = document.getElementById('authSubmit');
      const inp = document.getElementById('authPassword');
      btn?.addEventListener('click', unlockIfValid);
      inp?.addEventListener('keydown', (e) => { if (e.key === 'Enter') unlockIfValid(); });
    });
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { renderCatalogList(searchInput.value); }
    });
    // To use a real provider, swap out startDemoFeed as documented in the original code.
  </script>
</body>
</html>