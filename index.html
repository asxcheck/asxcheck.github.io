<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>ASX Check – Prices + AI Overview</title>
		<meta name="description" content="Enter ASX tickers to see live prices (no charts), get an AI-style overview (rise/fall/neutral), and simple recommendations." />
		<style>
			:root {
				--bg: #0f172a; /* slate-900 */
				--card: #111827; /* gray-900 */
				--muted: #94a3b8; /* slate-400 */
				--text: #e5e7eb; /* gray-200 */
				--accent: #22d3ee; /* cyan-400 */
				--positive: #22c55e; /* green-500 */
				--negative: #ef4444; /* red-500 */
				--warning: #f59e0b; /* amber-500 */
				--chip: #1f2937; /* gray-800 */
				--border: #1f2937;
			}
			* { box-sizing: border-box; }
			html, body { height: 100%; }
			body {
				margin: 0;
				font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell,
					Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
				background: linear-gradient(180deg, #0b1220 0%, var(--bg) 100%);
				color: var(--text);
			}
			header {
				padding: 24px 16px;
				display: flex;
				align-items: center;
				justify-content: space-between;
				max-width: 1080px;
				margin: 0 auto;
			}
			.title {
				display: flex; gap: 12px; align-items: center;
			}
			.title h1 { margin: 0; font-size: 20px; font-weight: 700; letter-spacing: 0.3px; }
			.badge { font-size: 12px; color: var(--muted); border: 1px solid var(--border); padding: 2px 8px; border-radius: 999px; }
			main { max-width: 1080px; margin: 0 auto; padding: 0 16px 48px; }
			.card {
				background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
				border: 1px solid var(--border);
				border-radius: 16px;
				padding: 16px;
				box-shadow: 0 10px 30px rgba(0,0,0,0.25);
			}
			.row { display: flex; flex-wrap: wrap; gap: 16px; }
			.grow { flex: 1 1 auto; }
			.controls { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
			input[type="text"] {
				background: #0b1020;
				color: var(--text);
				border: 1px solid var(--border);
				border-radius: 10px;
				padding: 10px 12px;
				outline: none;
				min-width: 260px;
			}
			button {
				background: linear-gradient(180deg, #22d3ee, #06b6d4);
				color: #002331;
				border: none;
				border-radius: 10px;
				padding: 10px 14px;
				font-weight: 700;
				cursor: pointer;
			}
			button.secondary { background: #111827; color: var(--text); border: 1px solid var(--border); }
			.chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
			.chip { background: var(--chip); border: 1px solid var(--border); padding: 6px 10px; border-radius: 999px; display: inline-flex; gap: 8px; align-items: center; }
			.chip button { background: transparent; color: var(--muted); border: none; padding: 0; cursor: pointer; }
			.muted { color: var(--muted); }
			.grid { display: grid; gap: 12px; margin-top: 16px; }
			@media (min-width: 720px) { .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
			@media (min-width: 980px) { .grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
			.stock {
				background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
				border: 1px solid var(--border);
				border-radius: 14px; padding: 14px; display: flex; flex-direction: column; gap: 10px;
			}
			.stock-header { display: flex; align-items: baseline; justify-content: space-between; gap: 12px; }
			.ticker { font-weight: 800; letter-spacing: 0.6px; }
			.name { color: var(--muted); font-size: 13px; }
			.price-row { display: flex; align-items: center; justify-content: space-between; }
			.price { font-size: 22px; font-weight: 800; }
			.chg { font-weight: 700; }
			.chg.up { color: var(--positive); }
			.chg.down { color: var(--negative); }
			.tiny { font-size: 12px; color: var(--muted); }
			.ai { background: #0b1020; border: 1px solid var(--border); border-radius: 12px; padding: 10px; }
			.ai strong { font-weight: 800; }
			.ai .rise { color: var(--positive); }
			.ai .fall { color: var(--negative); }
			.ai .neutral { color: var(--warning); }
			.section-title { margin: 20px 0 10px; font-size: 18px; font-weight: 800; letter-spacing: 0.3px; }
			.footer { margin-top: 24px; font-size: 12px; color: var(--muted); text-align: center; }
			.error { color: var(--negative); font-size: 13px; }
			.warn { color: var(--warning); font-size: 13px; }
			.loading { color: var(--muted); font-size: 13px; }
			.pill { border: 1px solid var(--border); border-radius: 999px; padding: 2px 8px; font-size: 12px; }
			.sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
			a { color: var(--accent); text-decoration: none; }
		</style>
	</head>
	<body>
		<header>
			<div class="title">
				<svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
					<path d="M3 17l5-5 4 4 7-7" stroke="#22d3ee" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
					<circle cx="4" cy="17" r="2" fill="#22d3ee"/>
					<circle cx="8" cy="13" r="2" fill="#22d3ee"/>
					<circle cx="12" cy="17" r="2" fill="#22d3ee"/>
					<circle cx="19" cy="10" r="2" fill="#22d3ee"/>
				</svg>
				<h1>ASX Check</h1>
				<span class="badge">No charts • Prices + AI overview</span>
			</div>
		</header>
		<main>
			<section class="card" aria-labelledby="watchlist-title">
				<h2 id="watchlist-title" class="sr-only">Watchlist</h2>
				<div class="row" style="align-items: center;">
					<div class="grow controls">
						<input id="ticker-input" type="text" placeholder="Add ASX tickers, e.g. BHP.AX, CBA.AX" aria-label="Ticker input" />
						<button id="add-btn">Add</button>
						<button class="secondary" id="clear-btn" title="Clear all">Clear</button>
					</div>
					<div>
						<span class="tiny">Tip: Use the .AX suffix. Max 12 tickers.</span>
					</div>
				</div>
				<div id="chips" class="chips" aria-live="polite"></div>
			</section>

			<section class="card" style="margin-top: 16px;" aria-labelledby="prices-title">
				<div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
					<h2 id="prices-title" class="section-title" style="margin:0;">Prices</h2>
					<div class="tiny" id="status-msg"></div>
				</div>
				<div id="stocks" class="grid" aria-live="polite"></div>
			</section>

			<section class="card" style="margin-top: 16px;" aria-labelledby="reco-title">
				<h2 id="reco-title" class="section-title" style="margin:0;">AI-based recommendations</h2>
				<div id="recos" class="grid"></div>
			</section>

			<p class="footer">
				Experimental and informational only. Not financial advice. Data via Yahoo Finance public quote endpoint; may be delayed or unavailable.
			</p>
		</main>

		<script>
			// --- Utilities ---
			const $ = (sel, el = document) => el.querySelector(sel);
			const $$ = (sel, el = document) => Array.from(el.querySelectorAll(sel));

			const DEFAULT_TICKERS = ["BHP.AX", "CBA.AX", "CSL.AX", "NAB.AX", "WES.AX"];
			const MAX_TICKERS = 12;
			const STORAGE_KEY = "asxcheck_tickers";

			const state = {
				tickers: [],
				quotes: new Map(), // ticker -> quote object
				scores: new Map(), // ticker -> score
				errors: new Map(), // ticker -> error message
			};

			function loadTickers() {
				try {
					const raw = localStorage.getItem(STORAGE_KEY);
					if (raw) {
						const list = JSON.parse(raw);
						if (Array.isArray(list) && list.length) return list.slice(0, MAX_TICKERS);
					}
				} catch {}
				return DEFAULT_TICKERS.slice();
			}

			function saveTickers() {
				localStorage.setItem(STORAGE_KEY, JSON.stringify(state.tickers));
			}

			function setStatus(msg, type = "") {
				const el = document.getElementById("status-msg");
				el.textContent = msg || "";
				el.className = type ? type : "tiny";
			}

			function normaliseTicker(t) {
				if (!t) return "";
				t = t.trim().toUpperCase();
				if (!t) return "";
				// Ensure .AX suffix if missing and looks like ASX code
				if (!t.endsWith(".AX") && /^[A-Z]{2,4}$/.test(t)) return t + ".AX";
				return t;
			}

			function renderChips() {
				const chips = document.getElementById("chips");
				chips.innerHTML = "";
				state.tickers.forEach(t => {
					const div = document.createElement("div");
					div.className = "chip";
					div.innerHTML = `<span>${t}</span> <button aria-label="Remove ${t}">✕</button>`;
					div.querySelector("button").onclick = () => {
						state.tickers = state.tickers.filter(x => x !== t);
						saveTickers();
						renderChips();
						refreshQuotes();
					};
					chips.appendChild(div);
				});
			}

			function renderStocks() {
				const container = document.getElementById("stocks");
				container.innerHTML = "";
				if (state.tickers.length === 0) {
					const p = document.createElement("p");
					p.className = "muted";
					p.textContent = "No tickers. Add ASX codes above to see prices.";
					container.appendChild(p);
					return;
				}

				state.tickers.forEach(ticker => {
					const q = state.quotes.get(ticker);
					const err = state.errors.get(ticker);

					const card = document.createElement("div");
					card.className = "stock";

					const header = document.createElement("div");
					header.className = "stock-header";
					header.innerHTML = `<div><span class="ticker">${ticker}</span> <span class="name">${q?.longName || q?.shortName || ""}</span></div>`;
					card.appendChild(header);

					const body = document.createElement("div");
					body.className = "price-row";

					if (err) {
						body.innerHTML = `<div class="error">${err}</div>`;
					} else if (!q) {
						body.innerHTML = `<div class="loading">Loading…</div>`;
					} else {
						const chg = q.regularMarketChangePercent;
						const chgClass = chg > 0 ? "up" : chg < 0 ? "down" : "";
						body.innerHTML = `
							<div class="price">${fmtPrice(q.regularMarketPrice, q.currency)}</div>
							<div style="text-align:right">
								<div class="chg ${chgClass}">${fmtSign(chg)}%</div>
								<div class="tiny">Prev ${fmtPrice(q.regularMarketPreviousClose, q.currency)}</div>
							</div>
						`;
					}
					card.appendChild(body);

					const actions = document.createElement("div");
					actions.style.display = "flex";
					actions.style.gap = "8px";
					actions.innerHTML = `<button class="secondary" ${q ? "" : "disabled"}>AI overview</button>`;
					const btn = actions.querySelector("button");
					btn.onclick = () => toggleAI(card, ticker);
					card.appendChild(actions);

					const ai = document.createElement("div");
					ai.className = "ai";
					ai.style.display = "none";
					ai.setAttribute("data-ai", ticker);
					card.appendChild(ai);

					container.appendChild(card);
				});
			}

			function toggleAI(card, ticker) {
				const ai = card.querySelector('.ai[data-ai="' + ticker + '"]');
				if (!ai) return;
				const visible = ai.style.display !== "none";
				ai.style.display = visible ? "none" : "block";
				if (!visible) renderAI(ai, ticker);
			}

			function renderAI(container, ticker) {
				const q = state.quotes.get(ticker);
				if (!q) { container.innerHTML = '<span class="loading">Loading…</span>'; return; }
				const res = aiOverview(q);
				container.innerHTML = `
					<div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
						<div><strong>AI view:</strong> <span class="${res.className}">${res.label}</span></div>
						<span class="pill">Score: ${res.score.toFixed(1)}</span>
					</div>
					<div class="tiny" style="margin-top:6px;">${res.expl}</div>
				`;
			}

					function renderRecommendations() {
						const recos = document.getElementById("recos");
						recos.innerHTML = "";
						if (state.quotes.size === 0) { return; }
						const items = state.tickers
							.map(t => {
								const q = state.quotes.get(t);
								if (!q) return null;
								const res = aiOverview(q);
								return { t, q, res };
							})
							.filter(Boolean)
							.sort((a,b) => b.res.score - a.res.score)
							.slice(0, 3);
						if (items.length === 0) {
							const p = document.createElement("p");
							p.className = "muted";
							p.textContent = "No recommendations available yet.";
							recos.appendChild(p);
							return;
						}
						items.forEach(({ t, q, res }) => {
							const card = document.createElement("div");
							card.className = "stock";
							card.innerHTML = `
								<div class="stock-header">
									<div><span class="ticker">${t}</span> <span class="name">${q?.longName || q?.shortName || ""}</span></div>
									<span class="pill">Score: ${res.score.toFixed(1)}</span>
								</div>
								<div class="price-row">
									<div class="price">${fmtPrice(q.regularMarketPrice, q.currency)}</div>
									<div class="${q.regularMarketChangePercent>0?"chg up":"chg down"}">${fmtSign(q.regularMarketChangePercent)}%</div>
								</div>
								<div class="tiny">${res.expl}</div>
							`;
							recos.appendChild(card);
						});
					}

			function fmtPrice(value, currency) {
				if (value == null || !isFinite(value)) return "-";
				const code = currency || "AUD";
				try {
					return new Intl.NumberFormat("en-AU", { style: "currency", currency: code }).format(value);
				} catch {
					return `${value.toFixed(2)} ${code}`;
				}
			}
			function fmtSign(num) {
				if (num == null || !isFinite(num)) return "-";
				const s = num >= 0 ? "+" : "";
				return s + num.toFixed(2);
			}

			// --- AI heuristic ---
			function aiOverview(q) {
				const price = n(q.regularMarketPrice);
				const chgPct = n(q.regularMarketChangePercent);
				const avg50 = n(q.fiftyDayAverage);
				const avg200 = n(q.twoHundredDayAverage);
				const prev = n(q.regularMarketPreviousClose);

				const trend50 = avg50 > 0 ? ((price - avg50) / avg50) * 100 : NaN;
				const trend200 = avg200 > 0 ? ((price - avg200) / avg200) * 100 : NaN;
				const momentum = chgPct; // today momentum

				// Weighted score: momentum 0.5, 50d 0.3, 200d 0.2
				const score = (isFinite(momentum) ? 0.5 * momentum : 0)
					+ (isFinite(trend50) ? 0.3 * trend50 : 0)
					+ (isFinite(trend200) ? 0.2 * trend200 : 0);

				let label = "Neutral"; let className = "neutral";
				if (score > 2) { label = "Expected rise"; className = "rise"; }
				else if (score < -2) { label = "Expected fall"; className = "fall"; }

				const parts = [];
				if (isFinite(momentum)) parts.push(`Day momentum ${fmtSign(momentum)}%`);
				if (isFinite(trend50)) parts.push(`vs 50d ${fmtSign(trend50)}%`);
				if (isFinite(trend200)) parts.push(`vs 200d ${fmtSign(trend200)}%`);
				if (isFinite(prev) && isFinite(price)) parts.push(`price ${fmtPrice(price, q.currency)}`);
				const expl = `${label} based on ${parts.join(", ")}.`;

				// Cache score for recommendations
				state.scores.set(q.symbol || q.shortName || "?", score);
				return { score, label, className, expl };
			}
			function n(v) { return v == null ? NaN : Number(v); }

			// --- Data fetch ---
			async function fetchQuotesBatch(symbols) {
				const endpoint = "https://query1.finance.yahoo.com/v7/finance/quote?symbols="
					+ encodeURIComponent(symbols.join(","));
				const res = await fetch(endpoint, { cache: "no-store" });
				if (!res.ok) throw new Error(`HTTP ${res.status}`);
				const data = await res.json();
				const list = data?.quoteResponse?.result || [];
				const bySymbol = new Map(list.map(x => [String(x.symbol).toUpperCase(), x]));
				return symbols.map(sym => bySymbol.get(sym.toUpperCase()) || null);
			}

			async function refreshQuotes() {
				renderChips();
				renderStocks();
				setStatus("Fetching prices…", "loading");

				state.quotes.clear();
				state.scores.clear();
				state.errors.clear();

				const tickers = state.tickers.slice(0, MAX_TICKERS);
				if (tickers.length === 0) { setStatus(""); renderRecommendations(); return; }

				// Yahoo supports batching; split into chunks of up to ~10 to be safe
				const chunks = [];
				for (let i = 0; i < tickers.length; i += 8) chunks.push(tickers.slice(i, i + 8));

				let anyOk = false; let anyErr = false;
				for (const group of chunks) {
					try {
						const results = await fetchQuotesBatch(group);
						results.forEach((q, idx) => {
							const sym = group[idx];
							if (q && isFinite(Number(q.regularMarketPrice))) {
								state.quotes.set(sym, q);
							} else {
								state.errors.set(sym, "No data returned (check symbol)");
							}
						});
						anyOk = true;
					} catch (e) {
						// Fallback: mark errors for this group
						group.forEach(sym => state.errors.set(sym, "Live data unavailable (CORS or network)"));
						anyErr = true;
					}
				}

				renderStocks();
				renderRecommendations();
				if (anyOk && !anyErr) setStatus("Live data loaded.");
				else if (anyOk && anyErr) setStatus("Partial data loaded; some failed.", "warn");
				else setStatus("Could not load live data. Try again later.", "error");
			}

			// --- Event handlers ---
			function onAddTickers() {
				const input = document.getElementById("ticker-input");
				const raw = input.value;
				const parts = raw.split(/[,\s]+/).map(normaliseTicker).filter(Boolean);
				input.value = "";
				if (parts.length === 0) return;
				const set = new Set(state.tickers);
				for (const p of parts) {
					if (set.size >= MAX_TICKERS) break;
					set.add(p);
				}
				state.tickers = Array.from(set).slice(0, MAX_TICKERS);
				saveTickers();
				renderChips();
				refreshQuotes();
			}

			function onClear() {
				state.tickers = [];
				saveTickers();
				renderChips();
				refreshQuotes();
			}

			// --- Init ---
			function init() {
				state.tickers = loadTickers();
				renderChips();
				renderStocks();
				refreshQuotes();

				document.getElementById("add-btn").addEventListener("click", onAddTickers);
				document.getElementById("clear-btn").addEventListener("click", onClear);
				const input = document.getElementById("ticker-input");
				input.addEventListener("keydown", (e) => {
					if (e.key === "Enter") onAddTickers();
				});
			}

			document.addEventListener("DOMContentLoaded", init);
		</script>
	</body>
</html>
