<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>ASX Check — Live Overview & AI Insights</title>
		<meta name="description" content="Live ASX stock overview with price and change, click for details and AI-style insights, plus an ideas pane suggesting new stocks." />
		<style>
			:root {
				--bg: #0b0d10;
				--panel: #11151b;
				--card: #141a22;
				--muted: #9fb0c0;
				--text: #e7edf3;
				--brand: #4aa3ff;
				--up: #19c37d;
				--down: #ff4d4d;
				--warn: #ffcc66;
				--border: #1e2630;
				--chip: #1b2330;
			}
			* { box-sizing: border-box; }
			html, body { margin: 0; padding: 0; height: 100%; background: var(--bg); color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
			a { color: var(--brand); text-decoration: none; }
			header {
				position: sticky; top: 0; z-index: 5;
				display: flex; align-items: center; justify-content: space-between;
				padding: 12px 16px; background: linear-gradient(180deg, rgba(11,13,16,0.95), rgba(11,13,16,0.6)); backdrop-filter: blur(6px);
				border-bottom: 1px solid var(--border);
			}
			.brand { display: flex; align-items: center; gap: 10px; }
			.brand h1 { margin: 0; font-size: 18px; font-weight: 700; letter-spacing: 0.3px; }
			.brand .badge { font-size: 12px; color: var(--muted); background: var(--chip); padding: 3px 8px; border-radius: 99px; border: 1px solid var(--border); }
			.actions { display: flex; gap: 8px; align-items: center; }
			button, input, select { font: inherit; color: var(--text); }
			.btn { background: #19212c; color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 8px 12px; cursor: pointer; transition: 0.15s ease; }
			.btn:hover { background: #1d2733; }
			.btn.primary { background: #173252; border-color: #1a3a60; color: #d8ebff; }
			.btn.primary:hover { background: #15314f; }
			.btn.ghost { background: transparent; border-color: var(--border); }
			.btn.small { padding: 6px 10px; border-radius: 8px; font-size: 12px; }
			.input { background: #0f141b; border: 1px solid var(--border); border-radius: 10px; padding: 8px 12px; color: var(--text); }
			.container { display: grid; grid-template-columns: 1fr 340px; gap: 16px; padding: 16px; }
			@media (max-width: 1024px) { .container { grid-template-columns: 1fr; } }
			.panel { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 12px; }
			.panel h2 { margin: 0 0 10px; font-size: 16px; font-weight: 700; color: #d9e6f2; }
			.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 12px; }
			.card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 12px; display: flex; flex-direction: column; gap: 8px; cursor: pointer; transition: 0.18s ease; }
			.card:hover { transform: translateY(-2px); box-shadow: 0 8px 18px rgba(0,0,0,0.25); }
			.ticker { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
			.ticker .sym { font-weight: 800; letter-spacing: 0.3px; }
			.name { font-size: 12px; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
			.price { display: flex; align-items: baseline; gap: 8px; }
			.price .p { font-size: 22px; font-weight: 700; }
			.chg { font-size: 12px; padding: 2px 8px; border-radius: 999px; border: 1px solid var(--border); background: #0f1620; }
			.chg.up { color: var(--up); background: rgba(25,195,125,0.08); border-color: rgba(25,195,125,0.25); }
			.chg.down { color: var(--down); background: rgba(255,77,77,0.08); border-color: rgba(255,77,77,0.25); }
			.meta { display: flex; gap: 10px; flex-wrap: wrap; }
			.chip { font-size: 11px; color: var(--muted); background: var(--chip); border: 1px solid var(--border); padding: 4px 8px; border-radius: 999px; }
			.row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
			.spacer { flex: 1; }
			.muted { color: var(--muted); }
			.footer { margin-top: 10px; font-size: 12px; color: var(--muted); display: flex; justify-content: space-between; align-items: center; gap: 8px; }
			.danger { color: var(--down); }
			.success { color: var(--up); }
			.warn { color: var(--warn); }

			/* Right drawer */
			.drawer {
				position: fixed; right: 0; top: 0; height: 100%; width: 420px; max-width: 95vw; background: #0f141a; border-left: 1px solid var(--border);
				box-shadow: -12px 0 24px rgba(0,0,0,0.35);
				transform: translateX(100%);
				transition: transform 0.22s ease-in-out; z-index: 20; display: flex; flex-direction: column;
			}
			.drawer.open { transform: translateX(0); }
			.drawer .head { display:flex; align-items:center; gap:10px; padding: 14px; border-bottom: 1px solid var(--border); background: #0c1117; }
			.drawer .content { padding: 14px; overflow: auto; display: flex; flex-direction: column; gap: 12px; }
			.kv { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
			.kv .item { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 10px; }
			.kv .label { font-size: 11px; color: var(--muted); }
			.kv .value { font-weight: 700; margin-top: 4px; }
			.insight { background: #0e1a12; border: 1px solid rgba(25,195,125,0.35); padding: 12px; border-radius: 12px; }
			.insight h3 { margin: 0 0 6px; font-size: 14px; }
			.ideas { display: grid; gap: 8px; }
			.idea { display:flex; align-items: center; justify-content: space-between; gap:10px; background: var(--card); border: 1px solid var(--border); padding: 10px; border-radius: 12px; }
			.idea .left { display:flex; flex-direction: column; }
			.idea .right { display:flex; gap: 6px; align-items: center; }
			.empty { color: var(--muted); font-style: italic; }

			.settings-modal {
				position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 40;
			}
			.settings-modal.open { display: flex; }
			.settings-card { width: 680px; max-width: 95vw; background: #0f141a; border: 1px solid var(--border); border-radius: 16px; padding: 16px; }
			.settings-card h3 { margin: 0 0 8px; }
			.settings-grid { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
			@media (max-width: 700px) { .settings-grid { grid-template-columns: 1fr; } }
			.field { display:flex; flex-direction: column; gap: 6px; }
			.field label { font-size: 12px; color: var(--muted); }
			.helper { font-size: 12px; color: var(--muted); }
			.tag { font-size: 11px; padding: 2px 6px; border-radius: 6px; border: 1px solid var(--border); background: var(--chip); color: var(--muted); }
		</style>
	</head>
	<body>
		<header>
			<div class="brand">
				<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
					<path d="M3 12c0-4.97 4.03-9 9-9s9 4.03 9 9-4.03 9-9 9" stroke="#4aa3ff" stroke-width="1.5"/>
					<path d="M4 16l4-6 4 3 4-6 4 8" stroke="#19c37d" stroke-width="1.5"/>
				</svg>
				<h1>ASX Check</h1>
				<span class="badge">Live overview + AI ideas</span>
			</div>
			<div class="actions">
				<div class="row">
					<input id="addSymbolInput" class="input" placeholder="Add ticker (e.g. CSL.AX)" size="16" />
					<button id="addSymbolBtn" class="btn">Add</button>
				</div>
				<button id="refreshBtn" class="btn">Refresh</button>
				<button id="settingsBtn" class="btn ghost">Settings</button>
			</div>
		</header>

		<main class="container">
			<section class="panel">
				<div class="row" style="margin-bottom:10px; align-items: baseline;">
					<h2>Watchlist</h2>
					<span id="lastUpdated" class="muted" style="margin-left:8px; font-size:12px;">—</span>
					<span class="spacer"></span>
					<span id="marketState" class="tag">ASX</span>
				</div>
				<div id="cards" class="grid" aria-live="polite"></div>
				<div class="footer">
					<span>Data from Yahoo Finance. No investment advice.</span>
					<div>
						<button id="clearWatchlist" class="btn small ghost" title="Reset to defaults">Reset</button>
						<button id="autoRefreshToggle" class="btn small" title="Toggle auto refresh">Auto refresh: <span id="autoRefreshState">On</span></button>
					</div>
				</div>
			</section>

			<aside class="panel">
				<div class="row" style="margin-bottom:10px; align-items: center;">
					<h2>AI Ideas</h2>
					<span class="spacer"></span>
					<button id="refreshIdeasBtn" class="btn small">Refresh ideas</button>
				</div>
				<div id="ideas" class="ideas">
					<div class="empty">Ideas will appear here using recent price action and basic fundamentals.</div>
				</div>
			</aside>
		</main>

		<!-- Drawer for detailed view -->
		<div id="drawer" class="drawer" role="dialog" aria-modal="true" aria-hidden="true">
			<div class="head">
				<div class="row" style="gap:10px; align-items: center;">
					<div style="font-weight:800;" id="drawerSym">—</div>
					<div class="muted" id="drawerName">—</div>
				</div>
				<span class="spacer"></span>
				<button id="drawerClose" class="btn small ghost">Close</button>
			</div>
			<div class="content">
				<div class="row" style="align-items: baseline;">
					<div class="price">
						<span id="drawerPrice" class="p">—</span>
						<span id="drawerChange" class="chg">—</span>
					</div>
					<span class="spacer"></span>
					<span id="drawerState" class="tag">—</span>
				</div>
				<div class="kv">
					<div class="item"><div class="label">Market cap</div><div id="kvCap" class="value">—</div></div>
					<div class="item"><div class="label">P/E (ttm)</div><div id="kvPE" class="value">—</div></div>
					<div class="item"><div class="label">Day range</div><div id="kvRange" class="value">—</div></div>
					<div class="item"><div class="label">Volume</div><div id="kvVol" class="value">—</div></div>
				</div>

				<div id="insightBox" class="insight">
					<h3>AI-style insight</h3>
					<div id="insightText" style="white-space: pre-wrap;">—</div>
					<div id="insightMeta" class="muted" style="margin-top:6px; font-size:12px;">Generated using simple rules. Configure Settings to enable LLM insights.</div>
				</div>

				<div class="panel" style="background:#0c1117;">
					<div class="row" style="align-items: center;">
						<h2 style="margin:0; font-size:14px;">Add to watchlist</h2>
						<span class="spacer"></span>
						<button id="addFromDrawer" class="btn small">Add</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Settings modal -->
		<div id="settingsModal" class="settings-modal" aria-hidden="true">
			<div class="settings-card">
				<div class="row" style="align-items:center; margin-bottom:8px;">
					<h3 style="margin:0;">Settings</h3>
					<span class="spacer"></span>
					<button id="closeSettings" class="btn small ghost">Close</button>
				</div>
				<p class="helper" style="margin-top:0;">Optionally enable an OpenAI-compatible API to generate richer insights. Keys are stored only in your browser.</p>
				<div class="settings-grid">
					<div class="field">
						<label for="llmBase">API Base URL</label>
						<input id="llmBase" class="input" placeholder="https://api.openai.com/v1" />
					</div>
					<div class="field">
						<label for="llmModel">Model</label>
						<input id="llmModel" class="input" placeholder="gpt-4o-mini" />
					</div>
					<div class="field" style="grid-column: 1 / -1;">
						<label for="llmKey">API Key</label>
						<input id="llmKey" class="input" type="password" placeholder="sk-..." />
					</div>
				</div>
				<div class="row" style="margin-top:10px;">
					<button id="saveSettings" class="btn primary">Save</button>
					<button id="clearSettings" class="btn ghost">Clear</button>
					<span class="spacer"></span>
					<span id="settingsStatus" class="helper"></span>
				</div>
			</div>
		</div>

		<script>
			// --- Config & Utilities ---
			const DEFAULT_TICKERS = [
				{ symbol: 'BHP.AX', name: 'BHP Group' },
				{ symbol: 'CBA.AX', name: 'Commonwealth Bank' },
				{ symbol: 'CSL.AX', name: 'CSL Limited' },
				{ symbol: 'NAB.AX', name: 'National Australia Bank' },
				{ symbol: 'WBC.AX', name: 'Westpac' },
				{ symbol: 'ANZ.AX', name: 'ANZ Group' },
				{ symbol: 'WOW.AX', name: 'Woolworths' },
				{ symbol: 'WES.AX', name: 'Wesfarmers' },
				{ symbol: 'TLS.AX', name: 'Telstra' },
				{ symbol: 'MQG.AX', name: 'Macquarie Group' },
				{ symbol: 'FMG.AX', name: 'Fortescue Metals' },
				{ symbol: 'RIO.AX', name: 'Rio Tinto' },
			];

			// Candidate pool for ideas (ASX 20/50 style mix)
			const IDEA_POOL = [
				'ALL.AX','AMC.AX','AMP.AX','ANZ.AX','APA.AX','ARB.AX','ASX.AX','BHP.AX','BXB.AX','CAR.AX','CCL.AX','CIM.AX','CGF.AX','COH.AX','COL.AX','CPU.AX','CBA.AX','CSL.AX','FPH.AX','FLT.AX','FMG.AX','GMG.AX','HVN.AX','IAG.AX','JHX.AX','LIC.AX','LLC.AX','MQG.AX','NAB.AX','NCM.AX','ORG.AX','ORI.AX','QAN.AX','QBE.AX','REA.AX','REH.AX','RIO.AX','RMD.AX','SCG.AX','SEK.AX','SHL.AX','S32.AX','SUN.AX','TLS.AX','TPG.AX','TCL.AX','WES.AX','WOR.AX','WOW.AX','WPL.AX'
			];

			const qs = (sel, el = document) => el.querySelector(sel);
			const qsa = (sel, el = document) => Array.from(el.querySelectorAll(sel));
			const fmt = new Intl.NumberFormat('en-AU');
			const fmtPrice = (n) => n == null ? '—' : (n >= 100 ? n.toFixed(2) : n >= 10 ? n.toFixed(3) : n.toFixed(4));
			const fmtPct = (n) => n == null ? '—' : `${(n * 100).toFixed(2)}%`;
			const fmtPctDirect = (n) => n == null ? '—' : `${n.toFixed(2)}%`;
			const fmtCap = (n) => {
				if (!n && n !== 0) return '—';
				const units = [[1e12,'T'],[1e9,'B'],[1e6,'M'],[1e3,'K']];
				for (const [v,s] of units) if (n >= v) return `${(n/v).toFixed(2)}${s}`;
				return String(n);
			};

			function save(key, val) { localStorage.setItem(key, JSON.stringify(val)); }
			function load(key, fallback) { try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch { return fallback; } }

			// --- Data fetchers (Yahoo Finance public endpoints) ---
			async function fetchQuotes(symbols) {
				if (!symbols?.length) return [];
				const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(symbols.join(','))}`;
				const res = await fetch(url, { cache: 'no-store' });
				if (!res.ok) throw new Error('Quote fetch failed');
				const json = await res.json();
				return json?.quoteResponse?.result ?? [];
			}

			async function fetchSpark(symbols, range = '5d', interval = '1d') {
				if (!symbols?.length) return {};
				const url = `https://query1.finance.yahoo.com/v8/finance/spark?symbols=${encodeURIComponent(symbols.join(','))}&range=${range}&interval=${interval}`;
				const res = await fetch(url, { cache: 'no-store' });
				if (!res.ok) throw new Error('Spark fetch failed');
				return await res.json();
			}

			// --- Rule-based AI-style insight ---
			function rulesInsight(quote, sparkSeries) {
				const lines = [];
				const price = quote.regularMarketPrice ?? quote.ask ?? quote.bid;
				const chg = quote.regularMarketChangePercent;
				const vol = quote.regularMarketVolume;
				const avgVol = quote.averageDailyVolume3Month ?? quote.averageDailyVolume10Day;
				const pe = quote.trailingPE;
				const fpe = quote.forwardPE;
				const cap = quote.marketCap;
				let trend5d = null;
				if (sparkSeries?.close?.length >= 2) {
					const arr = sparkSeries.close.filter(x => typeof x === 'number');
					if (arr.length >= 2) {
						trend5d = (arr[arr.length - 1] - arr[0]) / arr[0];
					}
				}

				// Momentum/volume
				if (chg != null) {
					if (chg > 2) lines.push('Strong positive session momentum with >2% daily gain.');
					else if (chg < -2) lines.push('Weak session; notable sell-off exceeding 2%.');
					else if (Math.abs(chg) < 0.5) lines.push('Sideways day with limited movement.');
				}

				if (vol && avgVol) {
					const volRatio = vol / avgVol;
					if (volRatio > 1.5) lines.push('Volume expanding vs 3-mo average, confirming move.');
					else if (volRatio < 0.6) lines.push('Subdued volume; price moves may lack conviction.');
				}

				if (trend5d != null) {
					if (trend5d > 0.03) lines.push('5-day trend is up >3%, short-term momentum favourable.');
					else if (trend5d < -0.03) lines.push('5-day trend is down >3%, sentiment weak near-term.');
				}

				if (pe != null) {
					if (pe < 12) lines.push('TTM P/E is relatively low; may indicate value or low growth.');
					else if (pe > 30) lines.push('Elevated P/E; market pricing in strong growth or premium quality.');
				}
				if (fpe != null && pe != null) {
					if (fpe < pe) lines.push('Forward P/E below trailing; analysts expect earnings improvement.');
				}
				if (cap != null && cap < 2e9) lines.push('Smaller market cap; expect higher volatility.');

				// Expected direction (very naive): blend day change and 5d trend
				let dirScore = 0;
				if (typeof chg === 'number') dirScore += Math.sign(chg) * Math.min(Math.abs(chg) / 2, 1); // normalize roughly
				if (typeof trend5d === 'number') dirScore += trend5d * 10; // amplify 5d %
				let expected = 'Neutral';
				let confidence = 0.45 + Math.min(Math.abs(dirScore) / 3, 0.4); // 45-85%
				if (dirScore > 0.25) expected = 'Likely up';
				else if (dirScore < -0.25) expected = 'Likely down';

				const summary = `Expected near-term: ${expected} (confidence ~${Math.round(confidence*100)}%).`;
				return { text: lines.join('\n') + (lines.length ? '\n' : '') + summary, expected, confidence };
			}

			// --- Optional LLM integration ---
			async function llmInsightIfConfigured(quote, sparkSeries) {
				const cfg = load('llmCfg', {});
				if (!cfg?.key || !cfg?.base || !cfg?.model) return null;
				const payload = {
					model: cfg.model,
					messages: [
						{ role: 'system', content: 'You are a concise equity analyst. Provide short insights (max 5 sentences), then a final line: "Expected near-term: <Up/Down/Neutral> (confidence ~NN%)." Avoid financial advice language.' },
						{ role: 'user', content: JSON.stringify({
							symbol: quote.symbol,
							name: quote.shortName || quote.longName || quote.symbol,
							price: quote.regularMarketPrice,
							changePct: quote.regularMarketChangePercent,
							marketCap: quote.marketCap,
							trailingPE: quote.trailingPE,
							forwardPE: quote.forwardPE,
							volume: quote.regularMarketVolume,
							avgVolume3m: quote.averageDailyVolume3Month,
							dayRange: [quote.regularMarketDayLow, quote.regularMarketDayHigh],
							trend5d: sparkSeries?.close?.length >= 2 ? (sparkSeries.close.at(-1) - sparkSeries.close[0]) / sparkSeries.close[0] : null,
						}, null, 2) }
					],
					temperature: 0.2,
				};
				try {
					const res = await fetch(cfg.base.replace(/\/$/, '') + '/chat/completions', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${cfg.key}` },
						body: JSON.stringify(payload)
					});
					if (!res.ok) throw new Error(await res.text());
					const data = await res.json();
					const content = data?.choices?.[0]?.message?.content?.trim();
					if (!content) return null;
					return { text: content, expected: null, confidence: null, llm: true };
				} catch (e) {
					console.warn('LLM insight failed:', e);
					return null;
				}
			}

			// --- State ---
			let watchlist = load('watchlist', DEFAULT_TICKERS);
			let autoRefresh = load('autoRefresh', true);
			let autoTimer = null;
			let currentQuotes = new Map();

			// --- Render ---
			function renderCards(quotes) {
				const cont = qs('#cards');
				cont.innerHTML = '';
				if (!quotes.length) {
					cont.innerHTML = '<div class="empty">No symbols. Add tickers like CSL.AX or TLS.AX.</div>';
					return;
				}
				quotes.forEach(q => {
					const chg = q.regularMarketChangePercent;
					const cls = chg > 0 ? 'up' : chg < 0 ? 'down' : '';
					const card = document.createElement('div');
					card.className = 'card';
					card.innerHTML = `
						<div class="ticker">
							<div class="sym">${q.symbol}</div>
							<div class="name" title="${q.shortName || q.longName || ''}">${q.shortName || q.longName || ''}</div>
						</div>
						<div class="price">
							<div class="p">${fmtPrice(q.regularMarketPrice)}</div>
							<div class="chg ${cls}">${chg == null ? '—' : (chg > 0 ? '▲ ' : chg < 0 ? '▼ ' : '') + fmtPctDirect(chg)}</div>
						</div>
						<div class="meta">
							<div class="chip">Mkt cap: ${fmtCap(q.marketCap)}</div>
							<div class="chip">P/E: ${q.trailingPE?.toFixed ? q.trailingPE.toFixed(2) : '—'}</div>
							<div class="chip">Vol: ${q.regularMarketVolume ? fmt.format(q.regularMarketVolume) : '—'}</div>
						</div>
					`;
					card.addEventListener('click', () => openDrawer(q.symbol));
					cont.appendChild(card);
				});
			}

			function renderFooter({ marketState, time }) {
				qs('#marketState').textContent = `ASX · ${marketState || '—'}`;
				qs('#lastUpdated').textContent = time ? `Updated ${time}` : '—';
				qs('#autoRefreshState').textContent = autoRefresh ? 'On' : 'Off';
			}

			// --- Main flow ---
			async function refreshQuotes() {
				try {
					const symbols = watchlist.map(x => x.symbol);
					const quotes = await fetchQuotes(symbols);
					// store
					currentQuotes = new Map(quotes.map(q => [q.symbol, q]));
					renderCards(quotes);
					const any = quotes[0];
					renderFooter({ marketState: any?.marketState, time: new Date().toLocaleString() });
				} catch (e) {
					console.error(e);
					qs('#cards').innerHTML = `<div class="empty">Failed to load quotes. ${e?.message || e}</div>`;
				}
			}

			function ensureAutoRefresh() {
				if (autoTimer) { clearInterval(autoTimer); autoTimer = null; }
				if (autoRefresh) autoTimer = setInterval(refreshQuotes, 60_000);
			}

			// --- Drawer ---
			async function openDrawer(symbol) {
				const drawer = qs('#drawer');
				const q = currentQuotes.get(symbol);
				if (!q) return;
				qs('#drawer').setAttribute('aria-hidden', 'false');
				drawer.classList.add('open');
				qs('#drawerSym').textContent = q.symbol;
				qs('#drawerName').textContent = q.shortName || q.longName || '';
				const chg = q.regularMarketChangePercent;
				const cls = chg > 0 ? 'chg up' : chg < 0 ? 'chg down' : 'chg';
				qs('#drawerPrice').textContent = fmtPrice(q.regularMarketPrice);
				const chgEl = qs('#drawerChange');
				chgEl.className = cls; chgEl.textContent = chg == null ? '—' : (chg > 0 ? '▲ ' : chg < 0 ? '▼ ' : '') + fmtPctDirect(chg);
				qs('#drawerState').textContent = q.marketState || '—';
				qs('#kvCap').textContent = fmtCap(q.marketCap);
				qs('#kvPE').textContent = q.trailingPE?.toFixed ? q.trailingPE.toFixed(2) : '—';
				qs('#kvRange').textContent = `${fmtPrice(q.regularMarketDayLow)} – ${fmtPrice(q.regularMarketDayHigh)}`;
				qs('#kvVol').textContent = q.regularMarketVolume ? fmt.format(q.regularMarketVolume) : '—';
				qs('#addFromDrawer').onclick = () => addToWatchlist(symbol, q.shortName || q.longName || symbol);

				// Insights: fetch spark and compute
				qs('#insightText').textContent = 'Generating...';
				qs('#insightMeta').textContent = 'Generated using simple rules. Configure Settings to enable LLM insights.';
				try {
					const spark = await fetchSpark([symbol], '5d', '1d');
					const series = spark?.[symbol];
					const llm = await llmInsightIfConfigured(q, series);
					if (llm?.text) {
						qs('#insightText').textContent = llm.text;
						qs('#insightMeta').textContent = 'Generated by your configured LLM.';
					} else {
						const r = rulesInsight(q, series);
						qs('#insightText').textContent = r.text;
					}
				} catch (e) {
					console.warn('Insight generation error', e);
					const r = rulesInsight(q, null);
					qs('#insightText').textContent = r.text + '\n(Note: trend data unavailable.)';
				}
			}
			function closeDrawer() {
				qs('#drawer').classList.remove('open');
				qs('#drawer').setAttribute('aria-hidden', 'true');
			}

			// --- Watchlist ops ---
			function persistWatchlist() { save('watchlist', watchlist); }
			async function addToWatchlist(symbol, name) {
				if (!symbol?.endsWith('.AX')) symbol = symbol + '.AX';
				if (watchlist.some(w => w.symbol.toUpperCase() === symbol.toUpperCase())) return;
				watchlist.push({ symbol: symbol.toUpperCase(), name: name || symbol.toUpperCase() });
				persistWatchlist();
				await refreshQuotes();
			}
			function resetWatchlist() {
				watchlist = [...DEFAULT_TICKERS];
				persistWatchlist();
				refreshQuotes();
			}

			// --- Ideas pane ---
			async function refreshIdeas() {
				const out = qs('#ideas');
				out.innerHTML = '<div class="empty">Scanning universe…</div>';
				try {
					// Only consider symbols not in watchlist
					const watchSet = new Set(watchlist.map(w => w.symbol.toUpperCase()));
					const pool = IDEA_POOL.filter(s => !watchSet.has(s.toUpperCase())).slice(0, 45);
					const quotes = await fetchQuotes(pool);
					// Rank by simple composite: 5d trend + day change, prefer liquid
					const symArr = quotes.map(q => q.symbol);
					const sparks = await fetchSpark(symArr, '5d', '1d');
					const scored = quotes.map(q => {
						const sp = sparks?.[q.symbol];
						let trend5d = 0;
						if (sp?.close?.length >= 2) {
							const a = sp.close.filter(x => typeof x === 'number');
							if (a.length >= 2) trend5d = (a[a.length-1] - a[0]) / a[0];
						}
						const day = (q.regularMarketChangePercent || 0) / 100;
						const volBoost = Math.min((q.regularMarketVolume || 0) / (q.averageDailyVolume3Month || 1), 2);
						const peAdj = (q.trailingPE && q.trailingPE > 0) ? (q.trailingPE < 15 ? 0.05 : q.trailingPE > 40 ? -0.05 : 0) : 0;
						const score = (trend5d * 0.7) + (day * 0.3) + (volBoost - 1) * 0.05 + peAdj;
						return { q, score, trend5d };
					}).sort((a,b) => b.score - a.score);

					const picks = scored.slice(0, 5);
					out.innerHTML = '';
					picks.forEach(({ q, trend5d }) => {
						const chg = q.regularMarketChangePercent;
						const el = document.createElement('div');
						el.className = 'idea';
						el.innerHTML = `
							<div class="left">
								<div><strong>${q.symbol}</strong> · <span class="muted">${q.shortName || q.longName || ''}</span></div>
								<div class="muted" style="font-size:12px;">Price ${fmtPrice(q.regularMarketPrice)} · Day ${chg == null ? '—' : fmtPctDirect(chg)} · 5d ${(trend5d*100).toFixed(2)}%</div>
							</div>
							<div class="right">
								<button class="btn small" data-add-symbol="${q.symbol}">Add</button>
								<button class="btn small ghost" data-open-symbol="${q.symbol}">View</button>
							</div>`;
						el.querySelector('[data-add-symbol]')?.addEventListener('click', () => addToWatchlist(q.symbol, q.shortName || q.longName || q.symbol));
						el.querySelector('[data-open-symbol]')?.addEventListener('click', () => openDrawer(q.symbol));
						out.appendChild(el);
					});
					if (!picks.length) out.innerHTML = '<div class="empty">No ideas right now. Try again later.</div>';
				} catch (e) {
					console.warn(e);
					out.innerHTML = '<div class="empty">Failed to load ideas.</div>';
				}
			}

			// --- Settings ---
			function openSettings() { qs('#settingsModal').classList.add('open'); qs('#settingsModal').setAttribute('aria-hidden', 'false');
				const cfg = load('llmCfg', {});
				qs('#llmBase').value = cfg.base || '';
				qs('#llmModel').value = cfg.model || '';
				qs('#llmKey').value = cfg.key || '';
				qs('#settingsStatus').textContent = '';
			}
			function closeSettings() { qs('#settingsModal').classList.remove('open'); qs('#settingsModal').setAttribute('aria-hidden', 'true'); }
			function saveSettings() {
				const base = qs('#llmBase').value.trim();
				const model = qs('#llmModel').value.trim();
				const key = qs('#llmKey').value.trim();
				save('llmCfg', { base, model, key });
				qs('#settingsStatus').textContent = 'Saved';
				setTimeout(() => { qs('#settingsStatus').textContent = ''; }, 1500);
			}
			function clearSettings() { localStorage.removeItem('llmCfg'); qs('#llmBase').value = ''; qs('#llmModel').value=''; qs('#llmKey').value=''; qs('#settingsStatus').textContent = 'Cleared'; setTimeout(()=>qs('#settingsStatus').textContent='', 1500); }

			// --- Events ---
			window.addEventListener('DOMContentLoaded', async () => {
				// Wire UI
				qs('#addSymbolBtn').addEventListener('click', async () => {
					const val = qs('#addSymbolInput').value.trim().toUpperCase();
					if (!val) return;
					await addToWatchlist(val, val);
					qs('#addSymbolInput').value = '';
				});
				qs('#addSymbolInput').addEventListener('keydown', async (e) => {
					if (e.key === 'Enter') { e.preventDefault(); qs('#addSymbolBtn').click(); }
				});
				qs('#refreshBtn').addEventListener('click', refreshQuotes);
				qs('#clearWatchlist').addEventListener('click', resetWatchlist);
				qs('#autoRefreshToggle').addEventListener('click', () => { autoRefresh = !autoRefresh; save('autoRefresh', autoRefresh); ensureAutoRefresh(); renderFooter({ marketState: qs('#marketState').textContent, time: new Date().toLocaleString() }); });
				qs('#drawerClose').addEventListener('click', closeDrawer);
				qs('#settingsBtn').addEventListener('click', openSettings);
				qs('#closeSettings').addEventListener('click', closeSettings);
				qs('#saveSettings').addEventListener('click', saveSettings);
				qs('#clearSettings').addEventListener('click', clearSettings);
				qs('#refreshIdeasBtn').addEventListener('click', refreshIdeas);
				// Escape to close drawer or settings
				window.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeDrawer(); closeSettings(); } });

				// Initial load
				await refreshQuotes();
				ensureAutoRefresh();
				await refreshIdeas();
			});
		</script>
	</body>
	</html>
